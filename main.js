(()=>{"use strict";const t=50;class e{constructor(t,e,s){this.canvas=t,this.context=e,this.speed=s,this.shapes=[],this.movingShape=void 0}moveShapeDown(){this.thereIsRoomToMoveDown()&&this.movingShape.moveDown()}moveShapeLeft(){this.thereIsRoomToMoveLeft()&&this.movingShape.moveLeft()}moveShapeRight(){this.thereIsRoomToMoveRight()&&this.movingShape.moveRight()}moveShapeToBottom(){for(;this.thereIsRoomToMoveDown();)this.moveShapeDown();this.movingShape.roundYCoordinatesToNearestTen()}noOtherShapeIsInTheWayDown(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>{const i=Math.round(s.y-(e.y+t)),n=Math.abs(i)<=this.speed.calculatedValue;return s.x===e.x&&n&&i>=0})))).length>0)return!1}return!0}noOtherShapeIsInTheWayLeft(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>s.x+t===e.x&&Math.abs(e.y-s.y)<t)))).length>0)return!1}return!0}noOtherShapeIsInTheWayRight(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>s.x===e.x+t&&Math.abs(e.y-s.y)<t)))).length>0)return!1}return!0}rotateShape(){this.movingShape.rotateClockwise(),this.allPointsFitInsideGrid()&&this.noOtherShapeIsInTheWay(this.movingShape)||this.movingShape.rotateCounterClockwise()}allPointsFitInsideGrid(){return this.movingShape.squares.map((t=>t.point.x)).every((e=>e>=0&&e<=this.canvas.width-t))&&this.movingShape.squares.map((t=>t.point.y)).every((e=>e>=0&&e<=this.canvas.height-t))}thereIsRoomToMoveDown(){return this.movingShape.getLargestY()+t<this.canvas.height&&this.noOtherShapeIsInTheWayDown()}thereIsRoomToMoveLeft(){return this.movingShape.getSmallestX()-t>=0&&this.noOtherShapeIsInTheWayLeft()}thereIsRoomToMoveRight(){return this.movingShape.getLargestX()+t<this.canvas.width&&this.noOtherShapeIsInTheWayRight()}removeFullRows(){const e=this.canvas.width/t,s=this.canvas.height/t;let i=0;for(let n=0;n<s;n+=1){const s=new Map;for(const e of this.shapes)for(const i of e.squares)i.point.y===n*t&&s.set(i,e);if(s.size===e){i+=1;for(const[t,e]of s)e.remove(t);this.shiftDownward(n)}}return i}shiftDownward(e){const s=e*t;for(const t of this.shapes)t.moveSquaresBelowYLimit(s)}noOtherShapeIsInTheWay(t){for(const e of this.shapes)if(e!==t&&e.hasCommonPointWith(t))return!1;return!0}hasOccupiedPoint(t,e){return this.shapes.map((s=>s.hasOccupiedPoint(t,e))).includes(!0)}print(){let e="";for(let s=0;s<this.canvas.height;s+=t){let i="";for(let e=0;e<this.canvas.width;e+=t)this.hasOccupiedPoint(e,s)?i+="⬛":i+="⬜";s!==this.canvas.height-t&&(i+="\n"),e+=i}return e}}class s{constructor(){this.high=s.getHighScore(),document.getElementById("high-score").innerText=this.high,this.current=0}static getHighScore(){let t=localStorage.getItem("tetris-high");return void 0===t&&(t=0),t}static calculateIncrease(t){return 2**t+2}increment(t){this.current+=t,document.getElementById("current-score").innerText=this.current}get(){return this.current}set(t){this.current=t}submit(){this.current>this.high&&(localStorage.setItem("tetris-high",this.current),document.getElementById("high-score").innerText=this.current,document.getElementById("scoreContainer").classList.add("shaken"),setTimeout((()=>document.getElementById("scoreContainer").classList.remove("shaken")),1e3))}}class i{constructor(t,e,s,i){this.canvas=t,this.context=e,this.shapeGenerator=s,this.speed=i}update(){if(this.grid.movingShape)this.grid.thereIsRoomToMoveDown()||(this.grid.movingShape.roundYCoordinatesToNearestTen(),this.grid.movingShape=void 0);else{const t=this.shapeGenerator.generateShape();this.grid.noOtherShapeIsInTheWay(t)?(this.grid.shapes.push(t),this.grid.movingShape=t):this.end()}this.grid.movingShape&&this.grid.thereIsRoomToMoveDown()&&this.grid.moveShapeDown()}draw(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.grid.shapes.forEach((t=>{t.draw()}))}gameLoop(){this.isPaused||this.isOver||(this.update(),this.draw(),this.currentAnimationFrameRequestId=window.requestAnimationFrame((()=>this.gameLoop())))}init(){this.setCanvasWidth(),this.setCanvasHeight(),window.setTimeout((()=>{document.getElementById("loading").hidden=!0,document.getElementById("container").style.display="grid"}),200),this.grid=new e(this.canvas,this.context,this.speed);const t=this.shapeGenerator.generateShape();this.grid.shapes.push(t),this.grid.movingShape=t,t.draw(),this.score=new s,document.getElementById("current-speed").innerText=this.speed.shownValue,this.SCORE_PER_SPEED_INCREASE=50,this.MAX_SPEED=9,this.paused=t=>{if(this.grid.movingShape)switch(t.key){case"p":this.pause()}},this.keyPressed=t=>{if(this.grid.movingShape)switch(t.key){case"j":this.grid.moveShapeLeft();break;case"k":this.grid.rotateShape();break;case"l":this.grid.moveShapeRight();break;case" ":if(this.grid.moveShapeToBottom(),!this.grid.thereIsRoomToMoveDown()){this.grid.movingShape=void 0;const t=this.grid.removeFullRows();t>0&&(this.requestScoreIncrease(t),this.requestSpeedIncrease())}}},this.keyHandler=this.keyPressed.bind(this),window.addEventListener("keypress",this.keyHandler),this.pauseKeyHandler=this.paused.bind(this),window.addEventListener("keypress",this.pauseKeyHandler),this.isPaused=!1,this.currentAnimationFrameRequestId=window.requestAnimationFrame((()=>this.gameLoop()))}setCanvasWidth(){500<window.screen.availWidth&&(this.canvas.width=500)}setCanvasHeight(){let t=window.screen.availHeight;t%100!=0&&(t-=t%100),t-=100,t>1e3&&(t=1e3),this.canvas.height=t}end(){this.score.submit(),i.showGameOverText(),window.clearInterval(this.heartbeatInterval),window.removeEventListener("keypress",this.keyHandler),window.removeEventListener("keypress",this.pauseKeyHandler),this.isOver=!0}requestSpeedIncrease(){if(this.speed.shownValue<this.MAX_SPEED){const t=Math.trunc(this.score.get()/this.SCORE_PER_SPEED_INCREASE)+1;this.speed.increaseIfNecessary(t)}}requestScoreIncrease(t){this.score.increment(t)}pause(){this.isPaused?(this.isPaused=!1,window.addEventListener("keypress",this.keyHandler),this.gameLoop()):(this.isPaused=!0,window.cancelAnimationFrame(this.currentAnimationFrameRequestId),window.removeEventListener("keypress",this.keyHandler))}static showGameOverText(){document.getElementById("gameOverContainer").hidden=!1}}class n{constructor(t,e){this.x=t,this.y=e}moveDownBy(t){this.y+=t}moveLeft(){this.x+=-50}moveRight(){this.x+=t}transformClockwise(t,e){this.translate(-t,-e),this.rotateClockwise(),this.translate(t,e)}transformCounterClockwise(t,e){this.translate(-t,-e),this.rotateCounterClockwise(),this.translate(t,e)}translate(t,e){this.x=this.x+t,this.y=this.y+e}rotateClockwise(){const t=this.x,e=this.y;this.x=-e,this.y=t}rotateCounterClockwise(){const t=this.x,e=this.y;this.x=e,this.y=-t}equals(t){return t instanceof n&&"number"==typeof t.x&&"number"==typeof t.y&&this.x===t.x&&this.y===t.y}occupiesCoordinates(t,e){return this.x===t&&this.y===e}roundYCoordinateToNearestTen(){const t=10*(this.y/10).toFixed();this.y=t}}class a{constructor(e,s,i,n){this.point=e,this.fillStyle=s,this.context=i,this.sideLength=t,this.speed=n}draw(){this.context.beginPath(),this.context.fillStyle=this.fillStyle,this.context.fillRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}clear(){this.context.clearRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}equals(t){return void 0!==t&&t instanceof a&&this.sideLength===t.sideLength&&this.point.equals(t.point)}overlaps(e){return void 0!==e&&e instanceof a&&this.sideLength===e.sideLength&&Math.abs(this.point.x-e.point.x)<t&&Math.abs(this.point.y-e.point.y)<t}moveDownBy(t){this.point.moveDownBy(t)}moveLeft(){this.point.moveLeft()}moveRight(){this.point.moveRight()}transformClockwise(t,e){this.point.transformClockwise(t,e)}transformCounterClockwise(t,e){this.point.transformCounterClockwise(t,e)}isBelowLimit(t){return this.point.y<t}hasOccupiedPoint(t,e){return this.point.occupiesCoordinates(t,e)}roundYCoordinateToNearestTen(){this.point.roundYCoordinateToNearestTen()}}class o{init(t,e,s,i,n){this.pointOfTranslation=e;const o=new a(e,t,i,n),h=s.map((e=>new a(e,t,i,n)));this.squares=[o,...h],this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX(),this.context=i,this.speed=n}getPointOfTranslationX(){return this.getPointOfTranslationX}remove(t){Object.prototype.hasOwnProperty.call(t,"point")&&Object.prototype.hasOwnProperty.call(t.point,"x")&&Object.prototype.hasOwnProperty.call(t.point,"y")&&(this.squares=this.squares.filter((e=>!e.equals(t))),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX())}draw(){this.squares.forEach((t=>t.draw()))}drawPoints(){this.squares.forEach((t=>t.drawPoint()))}clear(){this.squares.forEach((t=>t.clear()))}rotateClockwise(){this.squares.forEach((t=>{t.transformClockwise(this.pointOfTranslation.x,this.pointOfTranslation.y)})),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}rotateCounterClockwise(){this.squares.forEach((t=>{t.transformCounterClockwise(this.pointOfTranslation.x,this.pointOfTranslation.y)})),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}hasPoint(t){const e=this.squares.map((t=>new n(t.point.x,t.point.y))).filter((e=>e.equals(t)));return void 0!==e&&e.length&&0!==e.length&&e.equals(t)}hasCommonPointWith(t){for(const e of this.squares)for(const s of t.squares)if(e.overlaps(s))return!0;return!1}moveDown(){this.squares.forEach((t=>t.moveDownBy(this.speed.calculatedValue))),this.largestY=this.calculateLargestY()}moveLeft(){this.squares.forEach((t=>t.moveLeft())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}moveRight(){this.squares.forEach((t=>t.moveRight())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}calculateLargestY(){return this.squares.map((t=>t.point.y)).sort(((t,e)=>e-t))[0]}calculateSmallestX(){return this.squares.map((t=>t.point.x)).sort().shift()}calculateLargestX(){return this.squares.map((t=>t.point.x)).sort().pop()}getLargestY(){return this.largestY}getSmallestX(){return this.smallestX}getLargestX(){return this.largestX}moveSquaresBelowYLimit(e){this.squares.forEach((s=>{s.isBelowLimit(e)&&s.moveDownBy(t)}))}hasOccupiedPoint(t,e){return this.squares.map((s=>s.hasOccupiedPoint(t,e))).includes(!0)}roundYCoordinatesToNearestTen(){this.squares.forEach((t=>{t.roundYCoordinateToNearestTen()}))}}const h={I:class extends o{constructor(e,s,i){super();const a=new n(e,0,i),o=[new n(e-100,0,i),new n(e-t,0,i),new n(e+t,0,i)];super.init("yellowgreen",a,o,s,i)}},O:class extends o{constructor(e,s,i){super();const a=new n(e-t,0,i),o=new n(e,0,i),h=new n(e-t,t,i),r=new n(e,t,i),c=[a,o,h];super.init("thistle",r,c,s,i)}rotateClockwise(){}rotateCounterClockwise(){}},L:class extends o{constructor(e,s,i){super();const a=new n(e-100,0,i),o=new n(e-t,0,i),h=[a,new n(e,0,i),new n(e-100,t,i)];super.init("lightblue",o,h,s,i)}},J:class extends o{constructor(e,s,i){super();const a=new n(e-t,0,i),o=new n(e,0,i),h=[a,new n(e+t,0,i),new n(e+t,t,i)];super.init("darksalmon",o,h,s,i)}},S:class extends o{constructor(e,s,i){super();const a=new n(e-t,0,i),o=new n(e,0,i),h=new n(e-100,t,i),r=new n(e-t,t,i),c=[a,o,h];super.init("khaki",r,c,s,i)}},Z:class extends o{constructor(e,s,i){super();const a=new n(e-t,0,i),o=new n(e,0,i),h=new n(e,t,i),r=[a,o,new n(e+t,t,i)];super.init("tan",h,r,s,i)}},T:class extends o{constructor(e,s,i){super();const a=new n(e-t,t,i),o=new n(e,t,i),h=[a,new n(e+t,t,i),new n(e,0,i)];super.init("lightgrey",o,h,s,i)}}},r=document.createElement("canvas");r.setAttribute("id","gameCanvas"),document.getElementById("gameContainer").append(r);const c=r.getContext("2d"),l=new class{constructor(t){this.squareSideLength=t,this.shownValue=1,this.divisor=30,this.calculatedValue=this.calculateValue(t,this.divisor)}increase(){this.shownValue+=1,this.divisor-=1,this.calculatedValue=this.calculateValue(this.squareSideLength,this.divisor)}increaseIfNecessary(t){return t>this.shownValue&&(this.increase(),document.getElementById("speedContainer").classList.add("shaken"),setTimeout((()=>document.getElementById("speedContainer").classList.remove("shaken")),1e3),document.getElementById("current-speed").innerText=this.shownValue),this.shownValue}calculateValue(t,e){return Math.round(t/e)}}(t),u=new class{constructor(t,e,s){this.canvas=t,this.context=e,this.speed=s}generateShape(){const t=Object.values(h);return new(0,t[Math.round(Math.random()*(t.length-1))])(this.canvas.width/2,this.context,this.speed)}}(r,c,l);new i(r,c,u,l).init()})();
//# sourceMappingURL=main.js.map
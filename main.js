(()=>{"use strict";const e=50;class t{constructor(e,t,s){this.canvas=e,this.context=t,this.speed=s,this.shapes=[],this.movingShape=void 0}moveShapeDown(){this.thereIsRoomToMoveDown()&&this.movingShape.moveDown()}moveShapeLeft(){this.thereIsRoomToMoveLeft()&&this.movingShape.moveLeft()}moveShapeRight(){this.thereIsRoomToMoveRight()&&this.movingShape.moveRight()}moveShapeToBottom(){for(;this.thereIsRoomToMoveDown();)this.moveShapeDown()}noOtherShapeIsInTheWayDown(){const t=this.movingShape.squares.map((e=>e.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((e=>e.point));if(t.filter((t=>i.some((s=>{const i=Math.round(s.y-(t.y+e)),n=Math.abs(i)<=this.speed.calculatedValue;return s.x===t.x&&n&&i>=0})))).length>0)return!1}return!0}noOtherShapeIsInTheWayLeft(){const t=this.movingShape.squares.map((e=>e.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((e=>e.point));if(t.filter((t=>i.some((s=>s.x+e===t.x&&Math.abs(t.y-s.y)<e)))).length>0)return!1}return!0}noOtherShapeIsInTheWayRight(){const t=this.movingShape.squares.map((e=>e.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((e=>e.point));if(t.filter((t=>i.some((s=>s.x===t.x+e&&Math.abs(t.y-s.y)<e)))).length>0)return!1}return!0}rotateShape(){const e=this.movingShape.getCoordinatesOfSquares();this.movingShape.rotateClockwise(),this.allPointsFitInsideGrid()&&this.noOtherShapeIsInTheWay(this.movingShape)||this.movingShape.restoreCoordinatesOfSquares(e)}allPointsFitInsideGrid(){return this.movingShape.squares.map((e=>e.point.x)).every((t=>t>=0&&t<=this.canvas.width-e))&&this.movingShape.squares.map((e=>e.point.y)).every((t=>t>=0&&t<=this.canvas.height-e))}thereIsRoomToMoveDown(){return this.movingShape.getLargestY()+e<this.canvas.height&&this.noOtherShapeIsInTheWayDown()}thereIsRoomToMoveLeft(){return this.movingShape.getSmallestX()-e>=0&&this.noOtherShapeIsInTheWayLeft()}thereIsRoomToMoveRight(){return this.movingShape.getLargestX()+e<this.canvas.width&&this.noOtherShapeIsInTheWayRight()}removeFullRows(){const t=this.canvas.width/e,s=this.canvas.height/e;let i=0;for(let n=0;n<s;n+=1){const s=new Map;for(const t of this.shapes)for(const i of t.squares)i.point.y===n*e&&s.set(i,t);if(s.size===t){i+=1;for(const[e,t]of s)t.remove(e);this.shiftDownward(n)}}return this.shapes=this.shapes.filter((e=>e.squares.length>0)),i}shiftDownward(t){const s=t*e;for(const e of this.shapes)e.moveSquaresBelowYLimit(s)}noOtherShapeIsInTheWay(e){for(const t of this.shapes)if(t!==e&&t.hasCommonPointWith(e))return!1;return!0}hasOccupiedPoint(e,t){return this.shapes.map((s=>s.hasOccupiedPoint(e,t))).includes(!0)}print(){let t="";for(let s=0;s<this.canvas.height;s+=e){let i="";for(let t=0;t<this.canvas.width;t+=e)this.hasOccupiedPoint(t,s)?i+="⬛":i+="⬜";s!==this.canvas.height-e&&(i+="\n"),t+=i}return t}}class s{constructor(){this.high=s.getHighScore(),document.getElementById("high-score").innerText=this.high,this.current=0}static getHighScore(){let e=localStorage.getItem("tetris-high");return void 0===e&&(e=0),e}static calculateIncrease(e){return 2**e+2}increment(e){this.current+=e,document.getElementById("current-score").innerText=this.current}get(){return this.current}set(e){this.current=e}submit(){this.current>this.high&&(localStorage.setItem("tetris-high",this.current),document.getElementById("high-score").innerText=this.current,document.getElementById("scoreContainer").classList.add("shaken"),setTimeout((()=>document.getElementById("scoreContainer").classList.remove("shaken")),1e3))}}class i{constructor(e,t,s,i){this.canvas=e,this.context=t,this.shapeGenerator=s,this.speed=i}update(){if(this.grid.movingShape)if(this.grid.thereIsRoomToMoveDown())this.grid.moveShapeDown();else{this.grid.movingShape.roundYCoordinatesToNearestTen(),this.grid.movingShape=void 0;const e=this.grid.removeFullRows();e>0&&(this.requestScoreIncrease(e),this.requestSpeedIncrease())}else{const e=this.shapeGenerator.generateShape();this.grid.noOtherShapeIsInTheWay(e)?(this.grid.shapes.push(e),this.grid.movingShape=e):this.end()}}draw(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.grid.shapes.forEach((e=>{e===this.grid.movingShape?e.drawAsRectangles():e.drawAsSquares()}))}gameLoop(){this.isPaused||this.isOver||(this.update(),this.draw(),this.currentAnimationFrameRequestId=window.requestAnimationFrame((()=>this.gameLoop())))}init(){this.setCanvasWidth(),this.setCanvasHeight(),window.setTimeout((()=>{document.getElementById("loading").hidden=!0,document.getElementById("container").style.display="grid"}),200),this.grid=new t(this.canvas,this.context,this.speed),this.score=new s,document.getElementById("current-speed").innerText=this.speed.shownValue,this.SCORE_PER_SPEED_INCREASE=50,this.MAX_SPEED=9,this.paused=e=>{if(this.grid.movingShape)switch(e.key){case"p":this.pause()}},this.keyPressed=e=>{if(this.grid.movingShape)switch(e.key){case"j":this.grid.moveShapeLeft();break;case"k":this.grid.rotateShape();break;case"l":this.grid.moveShapeRight();break;case" ":this.grid.moveShapeToBottom()}},this.keyHandler=this.keyPressed.bind(this),window.addEventListener("keypress",this.keyHandler),this.pauseKeyHandler=this.paused.bind(this),window.addEventListener("keypress",this.pauseKeyHandler),this.isPaused=!1,this.currentAnimationFrameRequestId=window.requestAnimationFrame((()=>this.gameLoop()))}setCanvasWidth(){500<window.screen.availWidth&&(this.canvas.width=500)}setCanvasHeight(){let e=window.screen.availHeight;e%100!=0&&(e-=e%100),e-=100,e>1e3&&(e=1e3),this.canvas.height=e}end(){this.score.submit(),i.showGameOverText(),window.clearInterval(this.heartbeatInterval),window.removeEventListener("keypress",this.keyHandler),window.removeEventListener("keypress",this.pauseKeyHandler),this.isOver=!0}requestSpeedIncrease(){if(this.speed.shownValue<this.MAX_SPEED){const e=Math.trunc(this.score.get()/this.SCORE_PER_SPEED_INCREASE)+1;this.speed.increaseIfNecessary(e)}}requestScoreIncrease(e){this.score.increment(e)}pause(){this.isPaused?(this.isPaused=!1,window.addEventListener("keypress",this.keyHandler),this.gameLoop()):(this.isPaused=!0,window.cancelAnimationFrame(this.currentAnimationFrameRequestId),window.removeEventListener("keypress",this.keyHandler))}static showGameOverText(){document.getElementById("gameOverContainer").hidden=!1}}class n{constructor(e,t){this.x=e,this.y=t}moveDownBy(e){this.y+=e}moveLeft(){this.x+=-50}moveRight(){this.x+=e}transformClockwise(e,t){this.translate(-e,-t),this.rotateClockwise(),this.translate(e,t)}translate(e,t){this.x=this.x+e,this.y=this.y+t}rotateClockwise(){const e=this.x,t=this.y;this.x=-t,this.y=e,this.roundXCoordinateToNearestTen(),this.roundYCoordinateToNearestTen()}equals(e){return e instanceof n&&"number"==typeof e.x&&"number"==typeof e.y&&this.x===e.x&&this.y===e.y}occupiesCoordinates(e,t){return this.x===e&&this.y===t}roundYCoordinateToNearestTen(){this.y=this.roundToNearestTen(this.y)}roundXCoordinateToNearestTen(){this.x=this.roundToNearestTen(this.x)}roundToNearestTen(e){return 10*(e/10).toFixed()}}class a{constructor(t,s,i,n){this.point=t,this.fillStyle=s,this.context=i,this.sideLength=e,this.speed=n}draw(){this.context.beginPath(),this.context.fillStyle=this.fillStyle,this.context.fillRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}clear(){this.context.clearRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}equals(e){return void 0!==e&&e instanceof a&&this.sideLength===e.sideLength&&this.point.equals(e.point)}overlaps(t){return void 0!==t&&t instanceof a&&this.sideLength===t.sideLength&&Math.abs(this.point.x-t.point.x)<e&&Math.abs(this.point.y-t.point.y)<e}moveDownBy(e){this.point.moveDownBy(e)}moveLeft(){this.point.moveLeft()}moveRight(){this.point.moveRight()}transformClockwise(e,t){this.point.transformClockwise(e,t)}isBelowLimit(e){return this.point.y<e}hasOccupiedPoint(e,t){return this.point.occupiesCoordinates(e,t)}roundYCoordinateToNearestTen(){this.point.roundYCoordinateToNearestTen()}}class o{init(e,t,s,i,n){this.pointOfTranslation=t;const o=new a(t,e,i,n),r=s.map((t=>new a(t,e,i,n)));this.squares=[o,...r],this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX(),this.context=i,this.speed=n}getPointOfTranslationX(){return this.getPointOfTranslationX}remove(e){Object.prototype.hasOwnProperty.call(e,"point")&&Object.prototype.hasOwnProperty.call(e.point,"x")&&Object.prototype.hasOwnProperty.call(e.point,"y")&&(this.squares=this.squares.filter((t=>!t.equals(e))),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX())}drawAsSquares(){this.squares.forEach((e=>e.draw()))}drawPoints(){this.squares.forEach((e=>e.drawPoint()))}clear(){this.squares.forEach((e=>e.clear()))}rotateClockwise(){this.squares.forEach((e=>{e.transformClockwise(this.pointOfTranslation.x,this.pointOfTranslation.y)})),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}hasPoint(e){const t=this.squares.map((e=>new n(e.point.x,e.point.y))).filter((t=>t.equals(e)));return void 0!==t&&t.length&&0!==t.length&&t.equals(e)}hasCommonPointWith(e){for(const t of this.squares)for(const s of e.squares)if(t.overlaps(s))return!0;return!1}moveDown(){this.squares.forEach((e=>e.moveDownBy(this.speed.calculatedValue))),this.largestY=this.calculateLargestY()}moveLeft(){this.squares.forEach((e=>e.moveLeft())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}moveRight(){this.squares.forEach((e=>e.moveRight())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}calculateLargestY(){return this.squares.map((e=>e.point.y)).sort(((e,t)=>t-e))[0]}calculateSmallestX(){return this.squares.map((e=>e.point.x)).sort().shift()}calculateLargestX(){return this.squares.map((e=>e.point.x)).sort().pop()}getLargestY(){return this.largestY}getSmallestX(){return this.smallestX}getLargestX(){return this.largestX}moveSquaresBelowYLimit(t){this.squares.forEach((s=>{s.isBelowLimit(t)&&s.moveDownBy(e)}))}hasOccupiedPoint(e,t){return this.squares.map((s=>s.hasOccupiedPoint(e,t))).includes(!0)}roundYCoordinatesToNearestTen(){this.squares.forEach((e=>{e.roundYCoordinateToNearestTen()}))}getCoordinatesOfSquares(){return this.squares.map((e=>({x:e.point.x,y:e.point.y})))}restoreCoordinatesOfSquares(e){for(let t=0;t<e.length;t++)this.squares[t].point.x=e[t].x,this.squares[t].point.y=e[t].y;this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}drawAsRectangles(){const e=[...this.squares].sort(((e,t)=>e.point.y-t.point.y)).reduce(((e,t)=>{const s=e.find((e=>{const s=Math.abs(e.y+e.drawingHeight-t.point.y);return e.x===t.point.x&&s<1e-10}));return s?s.drawingHeight+=t.sideLength:e.push({x:t.point.x,y:t.point.y,drawingWidth:t.sideLength,drawingHeight:t.sideLength}),e}),[]);this.context.fillStyle=this.squares[0].fillStyle,e.forEach((e=>this.context.fillRect(e.x,e.y,e.drawingWidth,e.drawingHeight)))}}const r={I:class extends o{constructor(t,s,i){super();const a=new n(t,0,i),o=[new n(t-100,0,i),new n(t-e,0,i),new n(t+e,0,i)];super.init("yellowgreen",a,o,s,i)}},O:class extends o{constructor(t,s,i){super();const a=new n(t-e,0,i),o=new n(t,0,i),r=new n(t-e,e,i),h=new n(t,e,i),c=[a,o,r];super.init("thistle",h,c,s,i)}rotateClockwise(){}},L:class extends o{constructor(t,s,i){super();const a=new n(t-100,0,i),o=new n(t-e,0,i),r=[a,new n(t,0,i),new n(t-100,e,i)];super.init("lightblue",o,r,s,i)}},J:class extends o{constructor(t,s,i){super();const a=new n(t-e,0,i),o=new n(t,0,i),r=[a,new n(t+e,0,i),new n(t+e,e,i)];super.init("darksalmon",o,r,s,i)}},S:class extends o{constructor(t,s,i){super();const a=new n(t-e,0,i),o=new n(t,0,i),r=new n(t-100,e,i),h=new n(t-e,e,i),c=[a,o,r];super.init("khaki",h,c,s,i)}},Z:class extends o{constructor(t,s,i){super();const a=new n(t-e,0,i),o=new n(t,0,i),r=new n(t,e,i),h=[a,o,new n(t+e,e,i)];super.init("tan",r,h,s,i)}},T:class extends o{constructor(t,s,i){super();const a=new n(t-e,e,i),o=new n(t,e,i),r=[a,new n(t+e,e,i),new n(t,0,i)];super.init("lightgrey",o,r,s,i)}}},h=document.createElement("canvas");h.setAttribute("id","gameCanvas"),document.getElementById("gameContainer").append(h);const c=h.getContext("2d"),l=new class{constructor(e){this.shownValue=1,this.calculatedValue=e}increase(){this.shownValue+=1,this.calculatedValue=parseFloat((this.calculatedValue+.1).toFixed(1))}increaseIfNecessary(e){return e>this.shownValue&&(this.increase(),document.getElementById("speedContainer").classList.add("shaken"),setTimeout((()=>document.getElementById("speedContainer").classList.remove("shaken")),1e3),document.getElementById("current-speed").innerText=this.shownValue),this.shownValue}}(parseFloat(1.5625.toFixed(1))),u=new class{constructor(e,t,s){this.canvas=e,this.context=t,this.speed=s}generateShape(){const e=Object.values(r);return new(0,e[Math.round(Math.random()*(e.length-1))])(this.canvas.width/2,this.context,this.speed)}}(h,c,l);new i(h,c,u,l).init()})();
//# sourceMappingURL=main.js.map